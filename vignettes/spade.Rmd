---
title: "Spatial Association Detector(SPADE)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{spade}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



### Load data and package

We use the [`corrected boston bousing data`](https://jakubnowosad.com/spData/reference/boston.html) from the `spData` package and select a few variables to show how to apply the SPADE model.


``` r
library(sf)
library(tidyverse)
library(gdverse)

boston = spData::boston.c %>%
  as_tibble() %>%
  select(CMEDV,CRIM,RM,DIS,RAD,PTRATIO,LON,LAT) %>%
  st_as_sf(coords = c('LON','LAT'), crs = 4326)
boston
## Simple feature collection with 506 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -71.2895 ymin: 42.03 xmax: -70.81 ymax: 42.381
## Geodetic CRS:  WGS 84
## # A tibble: 506 × 7
##    CMEDV    CRIM    RM   DIS   RAD PTRATIO          geometry
##  * <dbl>   <dbl> <dbl> <dbl> <int>   <dbl>       <POINT [°]>
##  1  24   0.00632  6.58  4.09     1    15.3  (-70.955 42.255)
##  2  21.6 0.0273   6.42  4.97     2    17.8  (-70.95 42.2875)
##  3  34.7 0.0273   7.18  4.97     2    17.8  (-70.936 42.283)
##  4  33.4 0.0324   7.00  6.06     3    18.7  (-70.928 42.293)
##  5  36.2 0.0690   7.15  6.06     3    18.7  (-70.922 42.298)
##  6  28.7 0.0298   6.43  6.06     3    18.7 (-70.9165 42.304)
##  7  22.9 0.0883   6.01  5.56     5    15.2  (-70.936 42.297)
##  8  22.1 0.145    6.17  5.95     5    15.2  (-70.9375 42.31)
##  9  16.5 0.211    5.63  6.08     5    15.2  (-70.933 42.312)
## 10  18.9 0.170    6.00  6.59     5    15.2  (-70.929 42.316)
## # ℹ 496 more rows
```

### Spatial Autocorrelation of CMEDV

here I use `geocomplexity` to calculate the global **Moran's I**:


``` r
set.seed(123456789)

gmi = geocomplexity::moran_test(boston)
gmi
## ***                 global spatial autocorrelation test
```


-------------------------------------------------------------------
 Variable     MoranI         EI        VarI      zI         pI     
---------- ------------- ---------- ---------- ------- ------------
  CMEDV     0.336586***   -0.00198   0.000679   12.99   6.689e-39  

   CRIM     0.490946***   -0.00198   0.000679   18.92   4.129e-80  

    RM      0.187615***   -0.00198   0.000679   7.276   1.718e-13  

   DIS      0.489222***   -0.00198   0.000679   18.85   1.445e-79  

   RAD      0.829335***   -0.00198   0.000679   31.9    1.198e-223 

 PTRATIO    0.462886***   -0.00198   0.000679   17.84   1.723e-71  
-------------------------------------------------------------------



The global Moran'I Index of CMEDV is `0.336586` and the P value is `6.689e-39`,which shows that `CMEDV` has significant positive spatial autocorrelation in the global scale.

### SPADE modeling

*SPADE* explicitly considers the spatial variance by assigning the weight of the influence based on spatial distribution and also minimizes the influence of the number of levels on PD values by using the multilevel discretization and considering information loss due to discretization.

When response variable has a strong spatial dependence, maybe *SPADE* is a best choice.

The biggest difference between SPADE and native GD and OPGD in actual modeling is that SPADE requires a spatial weight matrix to calculate spatial variance.

In `spade` function, when you not provide a spatial weight matrix, it will use **1st order inverse distance weight** by default, which can be created by `inverse_distance_weight()`.


``` r
coords = boston |>
  st_centroid() |>
  st_coordinates()

wt1 = inverse_distance_weight(coords[,1],coords[,2])
```

You can also use gravity model weight by assigning the `power` parameter in `inverse_distance_weight()` function.


``` r
wt2 = inverse_distance_weight(coords[,1],coords[,2],power = 2)
```

#### using spatial weight matrix from sdsfun

I have also developed the [sdsfun](https://stscl.github.io/sdsfun/) package to facilitate the construction of spatial weight matrices, which requires an input of an sf object.


``` r
wt3 = sdsfun::spdep_contiguity_swm(boston)
```

Or using a spatial weight matrix based on distance kernel functions.


``` r
wt4 = sdsfun::spdep_distance_swm(boston, k = 6, kernel = 'gaussian')
```

In the following section we will execute *SPADE* model using spatial weight matrix `wt4` which is constructed by the gaussian distance kernel function and six nearest neighbor objects.

The test of *SPADE* model significance in `gdverse` is achieved by randomization null hypothesis use a pseudo-p value, this calculation is very time-consuming. Default `gdverse` sets the `permutations` parameter to 0 and does not calculate the pseudo-p value. If you want to calculate the pseudo-p value, specify the `permutations` parameter to a number such as 99,999,9999, etc.

#### run SPADE


``` r
boston_spade = spade(CMEDV ~ ., data = boston, wt = wt3, cores = 12)
boston_spade
## ***         Spatial Association Detector         
## 
## | variable | Q-statistic |      P-value      |
## |:--------:|:-----------:|:-----------------:|
## |   CRIM   | 0.99998547  | No Pseudo-P Value |
## |    RM    | 0.58681097  | No Pseudo-P Value |
## |   DIS    | 0.35004448  | No Pseudo-P Value |
## |   RAD    | 0.14994034  | No Pseudo-P Value |
## | PTRATIO  | 0.07880127  | No Pseudo-P Value |
plot(boston_spade,slicenum = 3)
```

![plot of chunk spade](man/figures/spade/spade-1.png)

**You can also access the detailed q statistics by `boston_spade$factor`**


``` r
boston_spade$factor
## # A tibble: 5 × 3
##   variable `Q-statistic` `P-value`        
##   <chr>            <dbl> <chr>            
## 1 CRIM            1.00   No Pseudo-P Value
## 2 RM              0.587  No Pseudo-P Value
## 3 DIS             0.350  No Pseudo-P Value
## 4 RAD             0.150  No Pseudo-P Value
## 5 PTRATIO         0.0788 No Pseudo-P Value
```
