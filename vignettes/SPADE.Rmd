---
title: "Spatial Association Detector(SPADE)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPADE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



### Load data and package


``` r
library(sf)
library(gdverse)
library(magrittr)
library(tidyverse)
usfi = read_sf(system.file('extdata/USFI_Xian.gpkg',package = 'gdverse'))
usfi
## Simple feature collection with 1037 features and 19 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 295713 ymin: 3784916 xmax: 324202.2 ymax: 3804669
## Projected CRS: WGS 84 / UTM zone 49N
## # A tibble: 1,037 × 20
##      LPI   LSI   GAR    DAR      WAR   TER  NDVI   NDWI   DTH   DTP    DTR   DTW    BH    BD
##    <dbl> <dbl> <dbl>  <dbl>    <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl> <dbl>
##  1  57.2 10.5  0.630 0.273  0.00219  0.979 0.497 -0.356  5.66 1.08  0.934   1.16 3.16  0.635
##  2  85.7  2.35 0.905 0.0952 0        0.977 0.514 -0.288  5.66 1.41  0.0807  1.57 0.310 0.139
##  3  41.2  7.85 0.436 0.449  0.000672 0.972 0.365 -0.296  4.38 1.88  0.516   2.37 3.99  0.671
##  4  39.1  5.40 0.534 0.377  0        0.966 0.395 -0.299  4.25 1.97  0.442   2.81 4.63  0.634
##  5  32.0  8.04 0.405 0.437  0        0.968 0.354 -0.302  3.65 1.34  0.615   2.55 4.07  0.642
##  6  58.3  7.91 0.332 0.615  0.000377 0.966 0.312 -0.271  3.69 0.700 0.592   2.25 7.91  0.777
##  7  98.4  3.34 0.984 0.0161 0        0.948 0.451 -0.248  5.39 1.36  0.124   3.64 0.216 0.111
##  8  44.6 17.6  0.416 0.502  0.000672 0.949 0.365 -0.295  5.11 1.20  0.926   2.50 6.49  0.747
##  9  35.9  9.81 0.464 0.467  0.00134  0.936 0.379 -0.309  7.10 2.01  1.03    2.75 5.49  0.692
## 10  44.3  9.49 0.403 0.504  0.000547 0.926 0.310 -0.278  8.51 2.68  0.658   3.20 3.27  0.601
## # ℹ 1,027 more rows
## # ℹ 6 more variables: RL <dbl>, RFD <dbl>, SVF <dbl>, FAR <dbl>, SUHI <dbl>,
## #   geom <POLYGON [m]>
```

The polygon spatial data are the streets divided based on roads within *the Ring expressway of Xi'an City*, and the attribute data are the *SUHI*(surface urban  heat island effect) and its influence factors.


```
## Error in knitr::include_graphics("man/figures/spade_studyarea.png"): Cannot find the file(s): "../man/figures/spade_studyarea.png"
```

### Spatial pattern of SUHI

#### global spatial autocorrelation of SUHI

here I use `sfdep` o calculate the global **Moran's I**


``` r
global_moranI = \(data,col,nb,wt){
  I = sfdep::global_moran(dplyr::pull(data,{{col}}),
                          dplyr::pull(data,{{nb}}),
                          dplyr::pull(data,{{wt}}),
                          na_ok = T)$I
  PValue = sfdep::global_moran_test(dplyr::pull(data,{{col}}),
                                    dplyr::pull(data,{{nb}}),
                                    dplyr::pull(data,{{wt}}),
                                    na.action = na.omit)$p.value
  moranI = c(I,PValue)
  names(moranI) = c("Moran'I Index","P Value")
  return(moranI)
}

usfi |>
  dplyr::filter(!if_any(everything(),is.na)) |>
  mutate(nb = sfdep::st_contiguity(geom),
         wt = sfdep::st_weights(nb)) |>
  dplyr::select(SUHI,nb,wt) -> new_usfi

new_usfi
## Simple feature collection with 1037 features and 3 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 295713 ymin: 3784916 xmax: 324202.2 ymax: 3804669
## Projected CRS: WGS 84 / UTM zone 49N
## # A tibble: 1,037 × 4
##     SUHI nb         wt                                                                     geom
##    <dbl> <nb>       <list>                                                        <POLYGON [m]>
##  1 1.76  <int [12]> <dbl [12]> ((297871.4 3787333, 297864.8 3787343, 297852.8 3787362, 297840.…
##  2 0.519 <int [2]>  <dbl [2]>  ((297398.6 3788768, 297397.5 3788779, 297395.2 3788804, 297393.…
##  3 3.04  <int [9]>  <dbl [9]>  ((297391.4 3789405, 297391 3789429, 297390.5 3789454, 297390.1 …
##  4 3.22  <int [4]>  <dbl [4]>  ((297244.1 3790712, 297240.4 3790729, 297235 3790751, 297229.6 …
##  5 3.47  <int [6]>  <dbl [6]>  ((296806.9 3791969, 296806.7 3791970, 296797.7 3791990, 296788.…
##  6 4.71  <int [6]>  <dbl [6]>  ((296484.5 3792805, 296481.4 3792815, 296474.7 3792837, 296467.…
##  7 1.24  <int [2]>  <dbl [2]>  ((296356.5 3793294, 296355.5 3793298, 296351.3 3793316, 296347.…
##  8 4.30  <int [8]>  <dbl [8]>  ((296154.6 3794673, 296152.3 3794688, 296148.6 3794713, 296144.…
##  9 3.76  <int [5]>  <dbl [5]>  ((296261.4 3798947, 296268.7 3798960, 296280.2 3798979, 296287.…
## 10 4.23  <int [5]>  <dbl [5]>  ((296996.6 3800017, 297000.9 3800022, 297013.3 3800038, 297025.…
## # ℹ 1,027 more rows
```

``` r

set.seed(123456789)

gmi = new_usfi |>
  global_moranI(SUHI,nb,wt)
gmi
## Moran'I Index       P Value 
##  5.359564e-01 5.078059e-217
```

The global Moran's Index is 0.5359564 and the P value is 5.0780594 &times; 10<sup>-217</sup>,which shows that SUHI in the main urban area of Xi'an has significant positive spatial autocorrelation in the global scale.

#### local spatial autocorrelation of SUHI

We will use `tidyrgeoda` to run the `LISA`, more details see [**here**](https://spatlyu.github.io/tidyrgeoda/articles/Local-Indicators-of-Spatial-Association.html)


``` r
library(tidyrgeoda)

new_usfi %>%
  mutate(lisa = st_local_moran(.,'SUHI',
                               wt = st_contiguity_weights(.),
                               significance_cutoff = 0.05)) %>%
  select(lisa) %>%
  ggplot() +
  geom_sf(aes(fill = lisa),lwd = .1,color = 'grey') +
  scale_fill_lisa(name = 'SUHI-LISA') +
  theme_bw() +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 5),
    legend.text = element_text(size = 5),
    legend.key.size = unit(.3, 'cm')
  )
```

<div class="figure">
<img src="man/figures/SPADE-SUHI_LISA-1.png" alt="plot of chunk SUHI_LISA" width="75%" />
<p class="caption">plot of chunk SUHI_LISA</p>
</div>

The global and local spatial autocorrelation shows that SUHI's strong spatial dependence.

Spatial dependence was neglected in native geodetector, which led to the **SPADE** spatial association detector.

### OPGD modeling


``` r
usfi_opgd = opgd(SUHI ~ ., data = st_drop_geometry(usfi), discnum = 3:15,
                 discvar = names(select(st_drop_geometry(usfi),-SUHI)),cores = 6)
```

**You can access the detailed q statistics by `usfi_opgd$factor`**


``` r
usfi_opgd$factor
## # A tibble: 18 × 3
##    variable `Q-statistic` `P-value`
##    <chr>            <dbl>     <dbl>
##  1 DAR             0.439   4.88e-10
##  2 NDVI            0.397   2.02e-10
##  3 GAR             0.382   8.25e-10
##  4 RFD             0.267   7.40e-10
##  5 BD              0.265   3.25e-10
##  6 BH              0.248   8.79e-11
##  7 NDWI            0.208   6.59e-10
##  8 FAR             0.198   1.35e-10
##  9 SVF             0.131   4.97e-10
## 10 RL              0.123   8.89e-10
## 11 TER             0.116   6.77e- 8
## 12 WAR             0.106   5.57e-10
## 13 LSI             0.0767  3.21e- 6
## 14 DTH             0.0763  7.67e- 6
## 15 DTP             0.0748  7.95e-10
## 16 DTW             0.0558  4.07e- 4
## 17 DTR             0.0529  3.94e- 7
## 18 LPI             0.0288  8.16e- 1
```

### SPADE modeling

*SPADE* explicitly considers the spatial variance by assigning the weight of the influence based on spatial distribution and also minimizes the influence of the number of levels on PD values by using the multilevel discretization and considering information loss due to discretization.

When response variable has a strong spatial dependence, maybe *SPADE* is a best choice.

The biggest difference between SPADE and native GD and OPGD in actual modeling is that SPADE requires a spatial weight matrix to calculate spatial variance.

In `gdverse`, when you not provide a spatial weight matrix, it will use **1st order inverse distance weight**, which can be created by `inverse_distance_weight()`.


``` r
coords = usfi |>
  st_centroid() |>
  st_coordinates()

wt1 = inverse_distance_weight(coords[,1],coords[,2])
```

You can also use gravity weight by assigning `power` parameter in `inverse_distance_weight()` function.


``` r
wt2 = inverse_distance_weight(coords[,1],coords[,2],power = 2)
```

You can also use spatial weight matrix from `sfdep`(which invoke `spdep`) or `tidyrgeoda`(which invoke `rgeoda``)

#### using spatial weight matrix from sfdep


``` r
wt3 = usfi |>
  dplyr::filter(!if_any(everything(),is.na)) |>
  mutate(nb = sfdep::st_contiguity(geom),
         wt = sfdep::st_weights(nb)) %$%
  sfdep::wt_as_matrix(nb,wt)
```

#### using spatial weight matrix from tidyrgeoda


``` r
wt4 = tidyrgeoda::st_contiguity_weights(usfi) |>
  as.matrix() |>
  apply(1,\(x) x/sum(x)) |>
  t()
```

The `wt3` is identical `wt4`


``` r
identical(wt3,wt4)
## [1] TRUE
```

In the following section we will execute *SPADE* model using  spatial weight matrix `wt3`.

#### run SPADE


``` r
usfi_spade = spade(SUHI ~ ., data = st_drop_geometry(usfi), wt = wt3, discnum = 3:15,
                   discvar = names(select(st_drop_geometry(usfi),-SUHI)),cores = 6)
usfi_spade
## Spatial Stratified Heterogeneity Test 
##  
##           Factor detector
```


----------------------------------
 variable   Q-statistic   P-value 
---------- ------------- ---------
   DAR        0.5029       0.01   

   NDVI        0.469       0.01   

   NDWI       0.4371       0.01   

   GAR        0.4199       0.01   

   RFD        0.3943       0.01   

   TER        0.3909       0.01   

    BD        0.3625       0.01   

    BH        0.3207       0.01   

   FAR        0.2161       0.01   

   DTR        0.2002       0.01   

   LSI        0.1685       0.01   

   DTP        0.1538       0.01   

    RL        0.1436       0.01   

   LPI        0.1424       0.01   

   DTW        0.1365       0.01   

   SVF        0.1268       0.01   

   DTH        0.08443      0.01   

   WAR          NA          NA    
----------------------------------



**You can also access the detailed q statistics by `usfi_spade$factor`**


``` r
usfi_spade$factor
## # A tibble: 18 × 3
##    variable `Q-statistic` `P-value`
##    <chr>            <dbl>     <dbl>
##  1 DAR             0.503       0.01
##  2 NDVI            0.469       0.01
##  3 NDWI            0.437       0.01
##  4 GAR             0.420       0.01
##  5 RFD             0.394       0.01
##  6 TER             0.391       0.01
##  7 BD              0.362       0.01
##  8 BH              0.321       0.01
##  9 FAR             0.216       0.01
## 10 DTR             0.200       0.01
## 11 LSI             0.169       0.01
## 12 DTP             0.154       0.01
## 13 RL              0.144       0.01
## 14 LPI             0.142       0.01
## 15 DTW             0.136       0.01
## 16 SVF             0.127       0.01
## 17 DTH             0.0844      0.01
## 18 WAR           NaN          NA
```
