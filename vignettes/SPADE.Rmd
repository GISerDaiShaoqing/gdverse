---
title: "Spatial Association Detector(SPADE)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPADE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



### Load data and package


``` r
library(sf)
library(tidyverse)
library(magrittr)
library(gdverse)

suhii = read_sf(system.file('extdata/SUHII.gpkg',package = 'gdverse'))
suhii
## Simple feature collection with 1128 features and 9 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 295713 ymin: 3784915 xmax: 324202.2 ymax: 3804678
## Projected CRS: WGS 84 / UTM zone 49N
## # A tibble: 1,128 × 10
##     SUHII    BH    BD   SVF   FAR     RD  ELEV  NDVI   NDWI                              geom
##     <dbl> <dbl> <dbl> <dbl> <dbl>  <dbl> <dbl> <dbl>  <dbl>                     <POLYGON [m]>
##  1 -0.633 0      1.00 0.995 0     0.0713  405. 0.445 -0.431 ((298066.3 3787032, 298062.5 378…
##  2  1.61  3.16   1.00 0.993 1.20  0.0182  403. 0.497 -0.484 ((297871.4 3787333, 297864.8 378…
##  3  1.13  0      1    0.986 0     0.0752  402. 0.419 -0.409 ((297538.7 3788005, 297537.9 378…
##  4  2.01  1.47   1    0.995 0.500 0.0784  404. 0.449 -0.433 ((297484.2 3788219, 297482.8 378…
##  5  0.452 0.310  1    0.996 0.121 0.0825  403. 0.514 -0.488 ((297398.6 3788768, 297397.5 378…
##  6  3.00  3.99   1.00 0.994 1.51  0.0207  400. 0.365 -0.378 ((297391.4 3789405, 297391 37894…
##  7  1.69  0      1    0.998 0     0.152   403. 0.267 -0.286 ((297253 3790673, 297250.8 37906…
##  8  4.07  4.63   1.00 0.991 1.74  0.0235  398. 0.395 -0.400 ((297244.1 3790712, 297240.4 379…
##  9  1.23  0      1    0.996 0     0.0875  400. 0.258 -0.268 ((297126.1 3791147, 297120.1 379…
## 10  3.87  4.07   1.00 0.993 1.60  0.0271  399. 0.354 -0.370 ((296806.9 3791969, 296806.7 379…
## # ℹ 1,118 more rows
```

<div class="figure" style="text-align: center">
<img src="../man/figures/spade/XianSUHII.png" alt="Overview Map of the Study Area Regarding SUHII" width="80%" />
<p class="caption">Overview Map of the Study Area Regarding SUHII</p>
</div>

This spatial polygon vector data `suhii` is the streets divided based on roads within *the Ring expressway of Xi'an City*, and the attribute data are the *SUHII*(Intensity of surface urban heat island effect) and its influence factors.

The meanings of each explanatory variable are as follows:

| Indicator | Meaning | Formula| Data source     |
|------------------|-------------------|------------------|------------------|
| SUHII     | Intensity of surface urban heat island effect| $$ SUHII = LST - LST_{mean\_suburbs} $$ | Landsat8 Images |
| BH        | Building height (the height from the roof surface to the outdoor ground level) | /  | CNBH10m Dataset |
| BD        | Building density (the ratio of the land area occupied by buildings to the total land area) | $$ BD = \frac{\sum_{i=1}^nBS_i}{S_{land}} $$| CNBH10m DataSet |
| SVF       | Sky View Factor (the ratio of the visible sky area at a specific point or area to the total ground area in its surrounding vicinity) | $$  SVF= \frac{1}{2\pi}\int_{0}^{2\pi}\left[\cos\beta\cos^{2}\phi+\sin\beta\cos(\vartheta-a)(90-\phi-\sin\phi\cos\phi)\right]\,d\vartheta $$ | GLO-30 DEM      |
| FAR       | Floor Area Ratio (the ratio of the total floor area of buildings on a site to the net land area of that site)  | $$ FAR = \frac{\sum_{i=1}^nBS_i\times\frac{BH}{3}}{s_{land}} $$  | CNBH10m Dataset |
| RD        | Road density (the ratio of the total road length to the area of the region) | $$ RD = \frac{RL_i\times RW_i}{S_{land}} $$  | OpenStreetMap   |
| ELEV      | Elevation | /| GLO-30 DEM      |
| NDVI      | Normalized difference vegetation index | $$ NDVI = \frac{NIR -R}{NIR + R} $$  | Landsat8 Image  |
| NDWI      | Normalized difference water index | $$ NDWI = \frac{G - NIR}{G + NIR} $$   | Landsat8 Image  |

### Spatial pattern of SUHI

#### global spatial autocorrelation of SUHI

here I use `sfdep` to calculate the global **Moran's I**:


``` r
global_moranI = \(data,col,nb,wt){
  I = sfdep::global_moran(dplyr::pull(data,{{col}}),
                          dplyr::pull(data,{{nb}}),
                          dplyr::pull(data,{{wt}}),
                          na_ok = T)$I
  PValue = sfdep::global_moran_test(dplyr::pull(data,{{col}}),
                                    dplyr::pull(data,{{nb}}),
                                    dplyr::pull(data,{{wt}}),
                                    na.action = na.omit)$p.value
  moranI = c(I,PValue)
  names(moranI) = c("Moran'I Index","P Value")
  return(moranI)
}

suhii |>
  dplyr::filter(!if_any(everything(),is.na)) |>
  mutate(nb = sfdep::st_contiguity(geom),
         wt = sfdep::st_weights(nb)) |>
  dplyr::select(SUHII,nb,wt) -> new_suhii

new_suhii
## Simple feature collection with 1128 features and 3 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 295713 ymin: 3784915 xmax: 324202.2 ymax: 3804678
## Projected CRS: WGS 84 / UTM zone 49N
## # A tibble: 1,128 × 4
##     SUHII nb         wt                                                                  geom
##     <dbl> <nb>       <list>                                                     <POLYGON [m]>
##  1 -0.633 <int [1]>  <dbl [1]>  ((298066.3 3787032, 298062.5 3787036, 298060.9 3787038, 2980…
##  2  1.61  <int [16]> <dbl [16]> ((297871.4 3787333, 297864.8 3787343, 297852.8 3787362, 2978…
##  3  1.13  <int [1]>  <dbl [1]>  ((297538.7 3788005, 297537.9 3788007, 297529.6 3788030, 2975…
##  4  2.01  <int [1]>  <dbl [1]>  ((297484.2 3788219, 297482.8 3788226, 297477.4 3788250, 2974…
##  5  0.452 <int [2]>  <dbl [2]>  ((297398.6 3788768, 297397.5 3788779, 297395.2 3788804, 2973…
##  6  3.00  <int [10]> <dbl [10]> ((297391.4 3789405, 297391 3789429, 297390.5 3789454, 297390…
##  7  1.69  <int [2]>  <dbl [2]>  ((297253 3790673, 297250.8 3790683, 297245.6 3790706, 297244…
##  8  4.07  <int [6]>  <dbl [6]>  ((297244.1 3790712, 297240.4 3790729, 297235 3790751, 297229…
##  9  1.23  <int [2]>  <dbl [2]>  ((297126.1 3791147, 297120.1 3791164, 297112.1 3791187, 2971…
## 10  3.87  <int [8]>  <dbl [8]>  ((296806.9 3791969, 296806.7 3791970, 296797.7 3791990, 2967…
## # ℹ 1,118 more rows
set.seed(123456789)

gmi = new_suhii |>
  global_moranI(SUHII,nb,wt)
gmi
## Moran'I Index       P Value 
##  4.934515e-01 5.256496e-175
```

The global Moran's Index is 0.4934515 and the P value is 5.2564961 &times; 10<sup>-175</sup>, which shows that SUHII in the core urban area of Xi'an has significant positive spatial autocorrelation in the global scale.

#### local spatial autocorrelation of SUHI

We will use `tidyrgeoda` to run the `LISA`, more details see [**here**](https://spatlyu.github.io/tidyrgeoda/articles/Local-Indicators-of-Spatial-Association.html)


``` r
library(tidyrgeoda)

new_suhii %>%
  mutate(lisa = st_local_moran(., 'SUHII',
                               wt = st_contiguity_weights(.),
                               significance_cutoff = 0.05)) %>%
  select(lisa) %>%
  ggplot() +
  geom_sf(aes(fill = lisa),lwd = .1,color = 'grey') +
  scale_fill_lisa(name = 'SUHII-LISA') +
  theme_bw() +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 7.5),
    legend.text = element_text(size = 7.5),
    legend.key.size = unit(.5, 'cm')
  )
```

![plot of chunk SUHII_LISA](man/figures/spade/SUHII_LISA-1.png)

The global and local spatial autocorrelation shows that SUHII's strong spatial dependence.

Spatial dependence was neglected in native geodetector, which leds to the development of **SPADE**(spatial association detector).

### OPGD modeling


``` r
suhii_opgd = opgd(SUHII ~ ., data = st_drop_geometry(suhii),
                  discvar = names(select(st_drop_geometry(new_suhii),-SUHII)),
                  cores = 12)
## Error in `dplyr::select()` at gdverse/R/opgd.R:49:3:
## ℹ In argument: `dplyr::all_of(c(yname, discvar))`.
## Caused by error in `dplyr::all_of()`:
## ! Can't subset elements that don't exist.
## ✖ Elements `nb` and `wt` don't exist.
suhii_opgd
## Error in eval(expr, envir, enclos): object 'suhii_opgd' not found
```

**You can access the detailed q statistics by `suhii_opgd$factor`.**


``` r
suhii_opgd$factor
## Error in eval(expr, envir, enclos): object 'suhii_opgd' not found
```

### SPADE modeling

*SPADE* explicitly considers the spatial variance by assigning the weight of the influence based on spatial distribution and also minimizes the influence of the number of levels on PD values by using the multilevel discretization and considering information loss due to discretization.

When response variable has a strong spatial dependence, maybe *SPADE* is a best choice.

The biggest difference between SPADE and native GD & OPGD in actual modeling is that SPADE requires a spatial weight matrix to calculate spatial variance.

In `gdverse`, when you not provide a spatial weight matrix, it will use **1st order inverse distance weight** by default, which can be created by `inverse_distance_weight()`.


``` r
coords = suhii |>
  st_centroid() |>
  st_coordinates()

wt1 = inverse_distance_weight(coords[,1],coords[,2])
```

You can also use gravity model weight by assigning the `power` parameter in `inverse_distance_weight()` function.


``` r
wt2 = inverse_distance_weight(coords[,1],coords[,2],power = 2)
```

#### using spatial weight matrix from sdsfun

I have also developed the [sdsfun](https://stscl.github.io/sdsfun/) package to facilitate the construction of spatial weight matrices, which requires an input of an sf object.


``` r
wt3 = sdsfun::spdep_contiguity_swm(suhii)
```

Or using a spatial weight matrix based on distance kernel functions.


``` r
wt4 = spdep_distance_swm(suhii,k = 3, kernel = 'gaussian')
## Error in spdep_distance_swm(suhii, k = 3, kernel = "gaussian"): could not find function "spdep_distance_swm"
```

In the following section we will execute *SPADE* model using spatial weight matrix `wt3` which is constructed by queen contiguity.

The test of *SPADE* model significance in `gdverse` is achieved by randomization null hypothesis use a pseudo-p value, this calculation is very time-consuming. Default `gdverse` sets the `permutations` parameter to 0 and does not calculate the pseudo-p value. If you want to calculate the pseudo-p value, specify the `permutations` parameter to a number such as 99,999,9999, etc.

#### run SPADE


``` r
suhii_spade = spade(SUHII ~ .,
                    data = st_drop_geometry(suhii),
                    wt = wt3, cores = 12)
suhii_spade
## ***         Spatial Association Detector         
## 
## | variable | Q-statistic |      P-value      |
## |:--------:|:-----------:|:-----------------:|
## |   NDVI   |  0.3146804  | No Pseudo-P Value |
## |   NDWI   |  0.3000413  | No Pseudo-P Value |
## |    RD    |  0.2551564  | No Pseudo-P Value |
## |   ELEV   |  0.1336964  | No Pseudo-P Value |
## |   SVF    |  0.1110880  | No Pseudo-P Value |
## |    BH    |     NaN     | No Pseudo-P Value |
## |    BD    |     NaN     | No Pseudo-P Value |
## |   FAR    |     NaN     | No Pseudo-P Value |
plot(suhii_spade,slicenum = 6)
```

![plot of chunk ushi_SPADE_factor](man/figures/spade/ushi_SPADE_factor-1.png)

**You can also access the detailed q statistics by `suhii_spade$factor`**


``` r
suhii_spade$factor
## # A tibble: 8 × 3
##   variable `Q-statistic` `P-value`        
##   <chr>            <dbl> <chr>            
## 1 NDVI             0.315 No Pseudo-P Value
## 2 NDWI             0.300 No Pseudo-P Value
## 3 RD               0.255 No Pseudo-P Value
## 4 ELEV             0.134 No Pseudo-P Value
## 5 SVF              0.111 No Pseudo-P Value
## 6 BH             NaN     No Pseudo-P Value
## 7 BD             NaN     No Pseudo-P Value
## 8 FAR            NaN     No Pseudo-P Value
```
